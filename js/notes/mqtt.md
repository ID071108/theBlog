# mqtt

MQTT 消息队列遥测传输（英语：Message Queuing Telemetry Transport）是 ISO 标准（ISO/IEC PRF 20922）下基于发布 (Publish)/订阅 (Subscribe)范式的消息协议，可视为"资料传递的桥梁"它工作在 TCP/IP 协议族上，是为硬件性能低下的远程设备以及网络状况糟糕的情况下而设计的发布/订阅型消息协议，为此，它需要一个消息中间件，以解决当前繁重的资料传输协议，如：HTTP。

## 历史

IBM 公司的安迪·斯坦福-克拉克及 Arcom 公司的阿兰·尼普于 1999 年撰写了该协议的第一个版本。

该协议的可用性取决于该协议的使用环境。IBM 公司在 2013 年就向结构化资讯标准促进组织提交了 MQTT 3.1 版规范，并附有相关章程，以确保只能对规范进行少量更改。MQTT-SN 是针对非 TCP/IP 网络上的嵌入式设备主要协议的变种，与此类似的还有 ZigBee 协议。

纵观行业的发展历程，“MQTT”中的“MQ” 是来自于 IBM 的 MQ 系列消息队列产品线。然而通常队列本身不需要作为标准功能来支持。

可选协议包含了高级消息队列协议，面向文本的消息传递协议，互联网工程任务组约束应用协议，可扩展消息与存在协议，数据分发服务，OPC UA 以及 web 应用程序消息传递协议。

MQTT 相较于 HTTP， 能节省更多的资源，带来较多的传输负担，也因为这样，在制造业中，让更多人发现 IoT 在设备、厂房的无限可能，发现原来要取机台的温度这么容易，要了解厂区的产量这么方便。

## 概览

MQTT 协议定义了两种网络实体

- 消息代理（message broker）
  消息代理用于接收来自客户端的消息并转发至目标客户端
- 客户端（client）
  MQTT 客户端可以是任何运行有 MQTT 库并通过网络连接至消息代理的设备，例如微型控制器或大型服务器

### 传输

- 信息的传输是通过主题（topic）管理的;发布者有需要分发的数据时，其向连接的消息代理发送携带有数据的控制消息;代理会向订阅此主题的客户端分发此数据;发布者不需要知道订阅者的数据和具体位置;同样，订阅者不需要配置发布者的相关信息.
- 客户端仅与代理有直接的数据传输，但整个系统中可能有多个代理，其于当前订阅者的主题交换数据。
- MQTT 控制消息最小只有 2 字节的数据, 最多可以承载 256 Mb 的数据.
  有 14 种预定义的消息类型用于：连接客户端与代理、断开连接、发布数据、确认数据接收、监督客户端与代理的连接
- MQTT 基于 TCP 协议，用于数据传输。变体 MQTT-SN 用于在蓝牙上传输，基于 UDP
- MQTT 默认端口为 1883。加密的端口为 8883.

### retained message

如果消息代理接受到某个主题上的消息，且这个主题没有任何订阅，那么代理就会丢弃之，除非发布者将其标记为保留消息（retained message）。

### 默认消息

当发布客户端首次与代理连接时，客户端可以设置一个默认消息。当代理发现发布者意外断开，其会向订阅者发送此预设的消息

### 连接

等待与服务器创建连接然后创建节点之间的连接

### 断开连接

等待 MQTT 客户端完成所必须完成的工作，然后等待 TCP/IP 会话关闭连接。

### 发布

将请求传递给 MQTT 客户端后立即返回到应用程序线程

### 服务质量（Qos）

服务质量指的是:

- 交通优先级和资源预留控制机制，而不是接收的服务质量。
- 服务质量是为不同应用程序，用户或数据流提供的不同优先级的能力，或者也可以说是为数据流保证一定的性能水平的能力

以下是每一个服务质量级别的具体描述

- 最多一次传送 (只负责传送，发送过后就不管数据的传送情况)
- 至少一次传送 (确认数据交付)
- 正好一次传送 (保证数据交付成功)
